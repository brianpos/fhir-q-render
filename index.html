<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE-Edge" />
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.6.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"
        integrity="sha512-L03kznCrNOfVxOUovR6ESfCz9Gfny7gihUX/huVbQB9zjODtYpxaVtIaAkpetoiyV2eqWbvxMH9fiSv5enX7bw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="fhirpath.min.js"></script>
    <script src="fhirpath.r4.min.js"></script>
    <script src="fhir-q-renderer.js" crossorigin="anonymous"></script>
    <style>
        pre {
            display: block;
            padding: 9.5px;
            margin: 0 0 10px;
            font-size: 13px;
            line-height: 1.428571429;
            word-break: break-all;
            word-wrap: break-word;
            color: #333333;
            background-color: #f5f5f5;
            border: 1px solid #cccccc;
            border-radius: 4px;
            white-space: pre-wrap;
        }

        .mandatory::after {
            content: " *";
            color: red;
        }
    </style>
</head>

<body>

    <div id="app">
        <table>
            <tr>
                <td>
                    <fhirq-item v-for="(item, index) in questionnaire.item" v-bind:item_defn="item"
                        v-bind:path="'questionnaire.item[' + index + ']'"
                        v-bind:context.sync="model.item_model[index]" v-bind:key="item.linkId">
                    </fhirq-item>
                </td>
                <td style="vertical-align: text-top;">
                    <button v-on:click="refreshQR">Refresh</button>
                    <pre style="height: 100%; min-width: 10px;" id="test">{{ QuestionnaireResponse }}</pre>
                </td>
            </tr>
        </table>
    </div>
    <div style="background-color:#fff; padding: 10px; min-height:1000px">
        <h3>FHIR path evaluation</h3>
        <div class="row">
            <div class="col-lg-6">
                <h4>Insert the FHIR resource below</h4>
                <br /><br />
                <div id="divPasteJson">
                    <textarea id="fhirResource" style="min-width:500px;height:700px;"></textarea>
                    <br /><br />
                    <h4>Type your Fhirpath expression below</h4>
                    <input id="path" value="Patient.name.where(use='usual').given.first()"
                        placeholder="fhirpath expr..." style="min-width:500px;">
                    <br />
                </div>
            </div>
            <div class="col-lg-6">
                <div class="fhirq-rendering-options">
                    <h3>Output</h3>
                    <br />
                    <span id="fhirpathOutput"> </span>
                </div>
            </div>
        </div>
    </div>

    <script>
        function loadPatient() {
            $.ajax({
                url: 'https://sqlonfhir-r4.azurewebsites.net/fhir/Patient/0ee71d9a69ac4c75a00373200445bea2?_format=json',
                headers: {
                    Accept: "application/json+fhir; charset=utf-8"
                },
                success: function (data) {
                    $('#fhirResource').text((typeof data === 'object') ? JSON.stringify(data, null, '\t') : data);
                    var returnedValue = fhirpath.evaluate(JSON.parse($('#fhirResource').val()), $('#path').val(), null, fhirpath_r4_model);
                    $('#fhirpathOutput').text(JSON.stringify(returnedValue));
                },
                error: function (ex, a, b) {
                    alert(JSON.stringify(ex));
                }
            });
        }

        $(document).ready(function () {
            $("#path").keyup(function () {
                try {
                    $('#fhirResource').val(JSON.stringify($.app.questionnaireResponse));
                    var fhirObject = JSON.parse($('#fhirResource').val());
                    var expression = $('#path').val();
                    var returnedValue = fhirpath.evaluate(fhirObject, expression, null, fhirpath_r4_model);
                    $('#fhirpathOutput').text(JSON.stringify(returnedValue));
                } catch (e) {
                    console.log(e.message);
                }
            });

            loadPatient();

        });

        $(function () {
            var app = new Vue({
                el: '#app',
                data: {
                    message: 'Hello Vue2!',
                    questionnaire: undefined,
                    QuestionnaireResponse: undefined,
                    model: undefined
                },
                methods: {
                    InitializeQuestionnaireResponse: function () {
                        this.QuestionnaireResponse = {
                            "resourceType": "QuestionnaireResponse",
                            "questionnaire": this.questionnaire.questionnaire,
                            "status": "in-progress"
                        };
                        // Generate the model
                    },
                    GetQuestionnaireResponse: function () {
                        // extract all the data
                        return QuestionnaireResponse;
                    },
                    refreshQR: function () {
                        $("#test").text(JSON.stringify(this.model.questionnaireresponse, null, 2))
                        // Process the extension
                        var contextVariables =
                        {
                            "questionnaire": this.model.questionnaire,
                            "resource": this.model.questionnaireresponse
                            // "LaunchPatient":{}, 
                            // "LaunchPractitioner": {}
                        };
                        var contextObject = this.model.questionnaireresponse;
                        var expression = "(%resource.item.item.where(linkId='Q10').answer.value & %resource.item.item.where(linkId='Q10b').answer.value) = 'chicken'";
                        var result = evalExpr(contextObject, expression, contextVariables);
                        // the result will have a boolean to show or not, or nothing
                    }
                }
            });
            $.ajax({
                //"https://build.fhir.org/ig/HL7/sdc/Questionnaire-questionnaire-sdc-profile-example-render.json"
                // https://localhost/ncsr-ig/Questionnaire-bow-1000182-1.json
                url: "https://sqlonfhir-r4.azurewebsites.net/fhir/Questionnaire/enable-when-tests",
                async: true,   // asynchronous request? (synchronous requests are discouraged...)
                cache: false,   // with this, you can force the browser to not make cache of the retrieved data
                dataType: "json",  // jQuery will infer this, but you can set explicitly
                success: function (data, textStatus, jqXHR) {
                    var resourceContent = data; // can be a global variable too...
                    // process the content...
                    app.message = "https://localhost/ncsr-ig/Questionnaire-bow-1000182-1.json";
                    app.questionnaire = resourceContent;
                    // app.questionnaire = {};
                    app.InitializeQuestionnaireResponse();
                    app.model = generateModel(app.questionnaire, app.QuestionnaireResponse);
                }
            });

        });

        function evalExpr(contextObject, expression, contextVariables) {
            var result = fhirpath.evaluate(contextObject, expression, contextVariables, fhirpath_r4_model);
            return result;
        }
    </script>
</body>

</html>